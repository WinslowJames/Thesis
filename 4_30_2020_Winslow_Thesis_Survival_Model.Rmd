---
title: "3_31_2020_Winslow_Thesis_Survival_Model"
author: "James Winslow"
date: "4/1/2020"
output: pdf_document
---
```{r Import_Data}
source("Winslow_Functions.R")

# this function creates a global object called thesis_data #
# make sure this isn't problematic since using '<<-' isn't a great habit #

import_data("local")

```

```{r}
source("Winslow_Functions.R")
library(dplyr)
library(reshape)

# this function creates a global object called Reshaped & cast_thesis #
# make sure this isn't problematic since using '<<-' isn't a great habit #

clean_data(thesis_data)
```

```{r}

# make a copy of the data for this next bit #
simple_model <- cast_thesis

# rename the variables so it's clear what we are using them for in the simple
# model
simple_model <- `colnames<-`(simple_model, c("id","time.to.death","n.events","dead"))
```


Since the purpose of the joint-model is to improve on inference that would be gained from either the survival model or the recurrent infections on their own, we want to demonstrate the results of each of those models on their own. 
\newline
Here, we present the formulation of a simple survival model using both an exponential and weibull form for the survival distribution. 
\newline
\section{Exponential Distribution}
\subsection{Overview} The exponential distribution is the simplest parametric model for survival time and assumes a constant risk over time. This is analagous with the more succint description of being a 'memoryless' distribution. This distribution is not influenced by the decided upon definition for time zero. 
\newline
\subsection{Formulation}
* pdf: $f(x) = \lambda e^{- \lambda x}$
* survival function: $S(x)= e^{-\lambda x}$
* hazard function: $\lambda(x) \equiv h(x) = \lambda , \lambda > 0$
* cumulative hazard: $\Lambda(x) = \lambda x$
* Expectation: $E[X] = \frac{1}{ \lambda}$
* Variance: $V[X] = \frac{1}{ \lambda ^{2}}$

\section{Weibull Distribution}
\subsection{Overview} The Weibull distribution is a two parameter family that results in the exponential distribution when the second parameter, $\gamma = 1$.
\subsection{Formulation}
* We denote $X \sim Weibull(\lambda,\gamma)$
* pdf: $f(x) = \lambda \gamma x^{ \gamma - 1}e^{- \lambda x^{ \gamma }}$
* survival function: $S(x) = e^{-\lambda x^{\gamma}}$
* hazard function: $\lambda(x) \equiv h(x) = \lambda \gamma x^{\gamma - 1}$
* cumulative hazard: $\Lambda(x) = \lambda x^{\gamma}$
* Expectation: $E[X] = \lambda^{-\frac{1}{\gamma}}\Gamma(1 + \frac{1}{\gamma})$
* Variance: $V[X] = \lambda^{-\frac{2}{\gamma}} \Big[ \Gamma(1 + \frac{2}{\gamma}) - \Gamma(1 + \frac{1}{\gamma})^{2}\Big]$



```{r}
# now do the survival element #
# we want to do a simpler model with the hazard being exponential #
# the survival function takes care of time and death variables #
# then we just need event distribution #
# poisson with offset for events #
  # log(time) of risk is the offset for events #
# shape of the hazard should match the joint model #

# Load required packages
library(rms)
library(survival)
library(survminer)
library(dplyr)


survival_model <- simple_model

# First, let's look at the Kaplan Meier #
KM_fit <- survfit(Surv(time = survival_model$time.to.death, event = survival_model$dead)~1, data = survival_model)

summary(KM_fit, times = c(1000, 2000))

plot(KM_fit, xlab = "Time to Death (days)", ylab = "Survival Probability", 
    main = "Kaplan-Meier Estimate")


plot(KM_fit, xlab = "Time to Death (days)", ylab = "Survival Probability", 
    main = "Kaplan-Meier Estimate", fun = "cumhaz")

### 

surv_object <- Surv(time = survival_model$time.to.death, event = simple_model$dead)


survive_mod_exp <- survreg(Surv(time.to.death,dead) ~ 1, data = survival_model, dist="exponential", x = TRUE)

survive_mod_weibull <- survreg(Surv(time.to.death,dead) ~ 1, data = survival_model, dist="weibull", x = TRUE)



summary(survive_mod_exp)
exponential_survial_results <- tibble(summary(survive_mod_exp))
exponential_survial_results[[1]]


summary(survive_mod_weibull)
weibull_survial_results <- tibble(summary(survive_mod_weibull))
weibull_survial_results[[1,]]


#   survreg's scale  =    1/(rweibull shape)
#   survreg's intercept = log(rweibull scale)
# pweibull already takes care of the log-log
# go back and look at curve function
# Scale = 2.97 
# Shape = 1/2.97 
#       = 0.3367003 
```



### Exponential Distribution

The exponential distribution is parameterized by a single rate parameter and only supports a hazard that is constant over time. 
$h(t)=\lambda=exp(-\beta_{0})$



### Weibull Distribution

In R, the Weibull is paramaterized as:
\begin{math}
 f(x|a,b) = \Big( \frac{a}{b}\Big) \Big(\frac{x}{b}\Big)^{a-1} e^{(-\frac{x}{b})^{a}}. 
 \end{math}
$0 \leq x < \infty$ , $a>0$ , $b>0$
 

### Survival Models With Covariates
The covariates available are : hospital site(2 versions), gender, race, organ, quarter, year, lt2
```{r}
# rename the variables so it's clear what we are adding covariates now
head(Reshaped)
cov_model <- `colnames<-`(Reshaped,c("id","time.to.death","n.events","dead","hospital","gender","race","organ","quarter","year","lt2","UngrpHospital"))

head(cov_model)
cov_model$log.time <- log(cov_model$time.to.death)
```

```{r}
# rename the variables so it's clear what we are adding covariates now
head(Reshaped)
cov_model <- `colnames<-`(Reshaped,c("id","time.to.death","n.events","dead","hospital","gender","race","organ","quarter","year","lt2","UngrpHospital"))

head(cov_model)
cov_model$log.time <- log(cov_model$time.to.death)
```


```{r}

# Load required packages
library(rms)
library(survival)
library(survminer)
library(dplyr)


### 
# + hospital + gender + race + organ + year + lt2
Reshaped <- `colnames<-`(Reshaped,c("id","time.to.death","n.events","dead","hospital","gender","race","organ","quarter","year","lt2","UngrpHospital")) 

surv_object <- Surv(time = Reshaped$time.to.death, event = Reshaped$dead)


survive_cov_exp <- survreg(Surv(time.to.death,dead) ~ hospital + gender + race + organ + year + lt2 , data = Reshaped, dist="exponential", x = TRUE)

survive_cov_weibull <- survreg(Surv(time.to.death,dead) ~ hospital + gender + race + organ + year + lt2, data = Reshaped, dist="weibull", x = TRUE)



summary(survive_cov_exp)
exponential_survial_cov_res <- tibble(summary(survive_cov_exp))
exponential_survial_cov_res[[1]]


summary(survive_cov_weibull)
weibull_survial_cov_res <- tibble(summary(survive_cov_weibull))
weibull_survial_cov_res[[1,]]



```