---
title: "Winslow_Thesis_Survival_Model"
author: "James Winslow"
date: "4/1/2020"
output: pdf_document
---
```{r Import_Data}
library(dplyr)
library(reshape)
source("Winslow_Functions.R")

# this function creates a global object called thesis_data #
# make sure this isn't problematic since using '<<-' isn't a great habit #

import_data("local")


# this function creates a global object called Reshaped & cast_thesis #
# make sure this isn't problematic since using '<<-' isn't a great habit #

clean_data(thesis_data)
clean_up(Reshaped)
```



```{r}
library(car)
### Relevel / recode for reference categories #

Reshaped$year <- Reshaped$year - min(Reshaped$year) 

# Make 'Heart' the reference category for organ transplant #

Reshaped$organ <- as.factor(Reshaped$organ)
Reshaped <- within(Reshaped, organ <- relevel(organ, ref = 'Heart'))

# Combine Race into White, Black, and Other #
Reshaped$race <- as.factor(Reshaped$race)
Reshaped <- within(Reshaped, race <- relevel(race, ref = 'White'))

```
Since the purpose of the joint-model is to improve on inference that would be gained from either the survival model or the recurrent infections on their own, we want to demonstrate the results of each of those models on their own. 
\newline
Here, we present the formulation of a simple survival model using both an exponential and weibull form for the survival distribution. 
\newline
\section{Exponential Distribution}
\subsection{Overview} The exponential distribution is the simplest parametric model for survival time and assumes a constant risk over time. This is analagous with the more succint description of being a 'memoryless' distribution. This distribution is not influenced by the decided upon definition for time zero. 
\newline
\subsection{Formulation}
* pdf: $f(x) = \lambda e^{- \lambda x}$
* survival function: $S(x)= e^{-\lambda x}$
* hazard function: $\lambda(x) \equiv h(x) = \lambda , \lambda > 0$
* cumulative hazard: $\Lambda(x) = \lambda x$
* Expectation: $E[X] = \frac{1}{ \lambda}$
* Variance: $V[X] = \frac{1}{ \lambda ^{2}}$

\section{Weibull Distribution}
\subsection{Overview} The Weibull distribution is a two parameter family that results in the exponential distribution when the second parameter, $\gamma = 1$.
\subsection{Formulation}
* We denote $X \sim Weibull(\lambda,\gamma)$
* pdf: $f(x) = \lambda \gamma x^{ \gamma - 1}e^{- \lambda x^{ \gamma }}$
* survival function: $S(x) = e^{-\lambda x^{\gamma}}$
* hazard function: $\lambda(x) \equiv h(x) = \lambda \gamma x^{\gamma - 1}$
* cumulative hazard: $\Lambda(x) = \lambda x^{\gamma}$
* Expectation: $E[X] = \lambda^{-\frac{1}{\gamma}}\Gamma(1 + \frac{1}{\gamma})$
* Variance: $V[X] = \lambda^{-\frac{2}{\gamma}} \Big[ \Gamma(1 + \frac{2}{\gamma}) - \Gamma(1 + \frac{1}{\gamma})^{2}\Big]$



```{r}
# now do the survival element #
# we want to do a simpler model with the hazard being exponential #
# the survival function takes care of time and death variables #
# then we just need event distribution #
# poisson with offset for events #
  # log(time) of risk is the offset for events #
# shape of the hazard should match the joint model #

# Load required packages
library(rms)
library(survival)
library(survminer)
library(dplyr)

# First, let's look at the Kaplan Meier #
KM_fit <- survfit(Surv(time = Reshaped$time.to.death, event = Reshaped$dead)~1, data = Reshaped)

summary(KM_fit, times = c(1000, 2000))

plot(KM_fit, xlab = "Time to Death (days)", ylab = "Survival Probability", 
    main = "Kaplan-Meier Estimate")
curve(-pweibull(x,shape=1/2.76,scale=2.76, lower.tail = FALSE, log = TRUE),add=TRUE) 





# change color of parametric fit so it's more visible
# remove the confidence intervals 
# add exponential plot also and have each as a different color
plot(KM_fit, xlab = "Time to Death (days)", ylab = "Cumulative Hazard", 
    main = "Kaplan-Meier Estimate", fun = "cumhaz")
curve(-pweibull(x,shape=1/2.97,scale=exp(15.1635), lower.tail = FALSE, log = TRUE),add=TRUE, col = "red")
curve(-pexp(x, rate = 2.97)
### 

surv_object <- Surv(time = Reshaped$time.to.death, event = Reshaped$dead)


survive_mod_exp <- survreg(Surv(time.to.death,dead) ~ 1, data = Reshaped, dist="exponential", x = TRUE)

survive_mod_weibull <- survreg(Surv(time.to.death,dead) ~ 1, data = Reshaped, dist="weibull", x = TRUE)



summary(survive_mod_exp)



summary(survive_mod_weibull)


```



### Exponential Distribution

The exponential distribution is parameterized by a single rate parameter and only supports a hazard that is constant over time. 
$h(t)=\lambda=exp(-\beta_{0})$



### Weibull Distribution

In R, the Weibull is paramaterized as:
\begin{math}
 f(x|a,b) = \Big( \frac{a}{b}\Big) \Big(\frac{x}{b}\Big)^{a-1} e^{(-\frac{x}{b})^{a}}. 
 \end{math}
$0 \leq x < \infty$ , $a>0$ , $b>0$
 

### Survival Models With Covariates
The covariates available are : hospital site(2 versions), gender, race, organ, quarter, year, lt2
```{r}
# rename the variables so it's clear what we are adding covariates now
head(Reshaped)

Reshaped$log.time <- log(Reshaped$time.to.death)
```




```{r}
### This chunk includes year and is otherwise identical to the later chunk #
# Load required packages
library(rms)
library(survival)
library(survminer)
library(dplyr)

options(scipen = 99)

surv_object <- Surv(time = Reshaped$time.to.death, event = Reshaped$dead)

# remember to remove hospital from the model as a continuous parameter  #
survive_cov_exp <- survreg(Surv(time.to.death,dead) ~ gender + race + organ + year + lt2 , data = Reshaped, dist="exponential", x = TRUE)

survive_cov_weibull <- survreg(Surv(time.to.death,dead) ~ gender + race + organ + year + lt2, data = Reshaped, dist="weibull", x = TRUE)



summary(survive_cov_exp)



summary(survive_cov_weibull)


# pull off the design matrix x
# model.matrix or model.frame




```

```{r}
# check exponential cumulative hazard with empirical survival plot # 
fitted_exp <- survive_cov_exp$linear.predictors
resids_exp <- (log(survive_cov_exp$y[, 1]) - fitted_exp) / survive_cov_exp$scale

resid_expKM <- survfit(Surv(resids_exp,dead) ~ 1, data = Reshaped)
plot(resid_expKM, mark.time = FALSE, xlab = "AFT Residuals" 
     , ylab = "Survival Probability")

xx_exp <- seq(min(resids_exp), max(resids_exp), length.out = 35)
yy_exp <- exp(-exp(xx_exp))
lines(xx_exp,yy_exp, col = "red", lwd = 2)
legend("bottomleft", c("KM estimate", "95% CI KM estimate", 
    "Survival function of Extreme Value distribution"), 
    lty = c(1,2,1), col = c(1,1,2), bty = "n")

```

```{r}

# check weibull cumulative hazard with empirical survival plot # 
fitted_weib <- survive_cov_weibull$linear.predictors
resids_weib <- (log(survive_cov_weibull$y[, 1]) - fitted_weib) / survive_cov_weibull$scale

resid_weibKM <- survfit(Surv(resids_weib,dead) ~ 1, data = Reshaped)
plot(resid_weibKM, mark.time = FALSE, xlab = "AFT Residuals" 
     , ylab = "Survival Probability")

xx_weib <- seq(min(resids_weib), max(resids_weib), length.out = 35)
yy_weib <- exp(-exp(xx_weib))
lines(xx_weib,yy_weib, col = "red", lwd = 2)
legend("bottomleft", c("KM estimate", "95% CI KM estimate", 
    "Survival function of Extreme Value distribution"), 
    lty = c(1,2,1), col = c(1,1,2), bty = "n")

# when i use curve, make add=true , lower tail = # 
# don't need CI when superimposing KM with parametric plots 
#
```

```{r}
curve(pweibull(x,shape=1/2.76,scale=2.76),0,80,ylab="Cumulative Proportion") 
curve(1-pweibull(x,shape=1/2.76,scale=2.76),0,80,ylab="Survival Proportion")

```

```{r}
### This chunk removed year but is otherwise identical to the earlier chunk #
# Load required packages
library(rms)
library(survival)
library(survminer)
library(dplyr)

options(scipen = 99)


surv_object <- Surv(time = Reshaped$time.to.death, event = Reshaped$dead)

# remember to remove hospital from the model as a continuous parameter  #
exp_no_year <- survreg(Surv(time.to.death,dead) ~ gender + race + organ + lt2 , data = Reshaped, dist="exponential", x = TRUE)

weibull_no_year <- survreg(Surv(time.to.death,dead) ~ gender + race + organ + lt2, data = Reshaped, dist="weibull", x = TRUE)



summary(exp_no_year)



summary(weibull_no_year)



# pull off the design matrix x
# model.matrix or model.frame




```

